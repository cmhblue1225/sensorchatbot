<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üì± Sensor Controller v6.0</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #0f172a;
            --surface: #1e293b;
            --card: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #475569;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }
        
        /* Ìó§Îçî */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1.5rem;
            min-height: calc(100vh - 120px);
        }
        
        /* Ïó∞Í≤∞ ÏÉÅÌÉú */
        .connection-status {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.75rem;
            background: var(--error);
            transition: background-color 0.3s ease;
        }
        
        .status-indicator.connected {
            background: var(--success);
            box-shadow: 0 0 12px var(--success);
        }
        
        .status-text {
            font-size: 1rem;
            font-weight: 600;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* ÏÑ∏ÏÖò ÏûÖÎ†• */
        .session-input-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .session-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            text-align: center;
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            letter-spacing: 0.2em;
            transition: border-color 0.3s ease;
        }
        
        .session-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .session-input::placeholder {
            color: var(--text-muted);
            letter-spacing: normal;
        }
        
        .connect-button {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .connect-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .connect-button:active {
            transform: translateY(0);
        }
        
        .connect-button:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }
        
        /* QR Ïä§Ï∫êÎÑà */
        .qr-scanner-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .qr-button {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .qr-button:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }
        
        /* Í≤åÏûÑ Ï†ïÎ≥¥ */
        .game-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .game-info.visible {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .game-type-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--primary);
            color: white;
            border-radius: 1rem;
            margin-bottom: 1rem;
        }
        
        .game-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .detail-item {
            text-align: center;
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* ÏÑºÏÑú ÏÉÅÌÉú */
        .sensor-status {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .sensor-status.visible {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .sensor-item {
            text-align: center;
            padding: 1rem;
            background: var(--background);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }
        
        .sensor-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sensor-value {
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            color: var(--primary);
        }
        
        /* ÌôúÎèô ÌëúÏãú */
        .activity-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 4px solid var(--primary);
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .activity-indicator.active {
            display: flex;
            animation: pulse 1s infinite;
        }
        
        .activity-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
        }
        
        /* Î©îÏãúÏßÄ */
        .message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        
        .message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }
        
        .message.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }
        
        .message.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        /* Î∞òÏùëÌòï */
        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }
            
            .session-input-section,
            .qr-scanner-section,
            .game-info,
            .sensor-status {
                padding: 1rem;
            }
            
            .sensor-grid {
                grid-template-columns: 1fr;
            }
            
            .game-details {
                grid-template-columns: 1fr;
            }
        }
        
        /* ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥ Ïπ¥Îìú */
        .player-info-card {
            background: var(--card);
            border: 2px solid var(--primary);
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: fadeIn 0.5s ease;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .player-number {
            font-size: 1.8rem;
            font-weight: 800;
        }
        
        .player-details {
            flex: 1;
        }
        
        .player-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .player-id {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }
        
        /* ÌîåÎ†àÏù¥Ïñ¥ ÏÉâÏÉÅ ÌåîÎ†àÌä∏ */
        .player-color-1 { background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important; }
        .player-color-2 { background: linear-gradient(135deg, #ef4444, #dc2626) !important; }
        .player-color-3 { background: linear-gradient(135deg, #10b981, #059669) !important; }
        .player-color-4 { background: linear-gradient(135deg, #f59e0b, #d97706) !important; }
        .player-color-5 { background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important; }
        .player-color-6 { background: linear-gradient(135deg, #06b6d4, #0891b2) !important; }
        .player-color-7 { background: linear-gradient(135deg, #f97316, #ea580c) !important; }
        .player-color-8 { background: linear-gradient(135deg, #84cc16, #65a30d) !important; }
        
        /* Ïà®ÍπÄ ÌÅ¥ÎûòÏä§ */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Ìó§Îçî -->
    <div class="header">
        <div class="header-content">
            <div class="logo">üì± Sensor Controller v6.0</div>
            <div class="subtitle">Î™®Î∞îÏùº ÏÑºÏÑúÎ•º Í≤åÏûÑ Ïª®Ìä∏Î°§Îü¨Î°ú ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî</div>
        </div>
    </div>
    
    <!-- Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="container">
        <!-- Ïó∞Í≤∞ ÏÉÅÌÉú -->
        <div class="connection-status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span class="status-text" id="statusText">ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ï§ë...</span>
        </div>
        
        <!-- Î©îÏãúÏßÄ -->
        <div class="message" id="message"></div>
        
        <!-- ÏÑ∏ÏÖò ÏûÖÎ†• -->
        <div class="session-input-section" id="sessionInputSection">
            <div class="section-title">üéÆ Í≤åÏûÑ ÏÑ∏ÏÖò Ïó∞Í≤∞</div>
            <div class="input-group">
                <label class="input-label">4ÏûêÎ¶¨ ÏÑ∏ÏÖò ÏΩîÎìú ÏûÖÎ†•</label>
                <input type="text" 
                       class="session-input" 
                       id="sessionInput" 
                       placeholder="0000"
                       maxlength="4"
                       pattern="[0-9]{4}"
                       inputmode="numeric">
            </div>
            <button class="connect-button" id="connectButton" disabled>
                üîó Í≤åÏûÑÏóê Ïó∞Í≤∞
            </button>
        </div>
        
        <!-- QR Ïä§Ï∫êÎÑà -->
        <div class="qr-scanner-section" id="qrScannerSection">
            <div class="section-title">üì∑ QR ÏΩîÎìú Ïä§Ï∫î</div>
            <button class="qr-button" id="qrButton">
                üì∑ QR ÏΩîÎìú Ïä§Ï∫îÌïòÍ∏∞
            </button>
            <div id="qr-reader" style="display: none; margin-top: 1rem;"></div>
        </div>
        
        <!-- Í≤åÏûÑ Ï†ïÎ≥¥ -->
        <div class="game-info" id="gameInfo">
            <div class="section-title">üéÆ Ïó∞Í≤∞Îêú Í≤åÏûÑ</div>
            <div class="game-type-badge" id="gameTypeBadge">SOLO</div>
            
            <!-- ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥ Ïπ¥Îìú -->
            <div class="player-info-card" id="playerInfoCard">
                <div class="player-avatar" id="playerAvatar">
                    <span class="player-number" id="playerNumber">?</span>
                </div>
                <div class="player-details">
                    <div class="player-name" id="playerName">ÌîåÎ†àÏù¥Ïñ¥</div>
                    <div class="player-id" id="playerId">Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...</div>
                </div>
            </div>
            
            <div class="game-details">
                <div class="detail-item">
                    <div class="detail-label">Ïó∞Í≤∞Îêú ÌîåÎ†àÏù¥Ïñ¥</div>
                    <div class="detail-value" id="connectedSensors">0/1</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Í≤åÏûÑ ÏÉÅÌÉú</div>
                    <div class="detail-value" id="gameStatus">ÎåÄÍ∏∞ Ï§ë</div>
                </div>
            </div>
            <button class="btn btn-primary" id="startSensorBtn" style="width: 100%; margin-top: 1rem;" disabled>
                üì± ÏÑºÏÑú ÏãúÏûëÌïòÍ∏∞
            </button>
        </div>
        
        <!-- ÏÑºÏÑú ÏÉÅÌÉú -->
        <div class="sensor-status" id="sensorStatus">
            <div class="section-title">üìä Ïã§ÏãúÍ∞Ñ ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞</div>
            <div class="sensor-grid">
                <div class="sensor-item">
                    <div class="sensor-label">Í∏∞Ïö∏Í∏∞ X</div>
                    <div class="sensor-value" id="tiltX">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">Í∏∞Ïö∏Í∏∞ Y</div>
                    <div class="sensor-value" id="tiltY">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">ÌöåÏ†Ñ Z</div>
                    <div class="sensor-value" id="rotationZ">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">Í∞ÄÏÜçÎèÑ X</div>
                    <div class="sensor-value" id="accelX">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">Í∞ÄÏÜçÎèÑ Y</div>
                    <div class="sensor-value" id="accelY">0.0</div>
                </div>
                <div class="sensor-item">
                    <div class="sensor-label">Í∞ÄÏÜçÎèÑ Z</div>
                    <div class="sensor-value" id="accelZ">0.0</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÌôúÎèô ÌëúÏãú -->
    <div class="activity-indicator" id="activityIndicator">
        <div class="activity-text">ÏÑºÏÑú ÌôúÎèô</div>
    </div>
    
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- QR Code Scanner (optional) -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- SessionSDK -->
    <script src="/js/SessionSDK.js"></script>
    
    <!-- Sensor Controller Script -->
    <script>
        class SensorController {
            constructor() {
                // SDK Ï¥àÍ∏∞Ìôî
                this.sdk = new SessionSDK({
                    gameId: 'sensor-controller',
                    gameType: 'client',
                    debug: true
                });
                
                // ÏÑºÏÑú ÏàòÏßëÍ∏∞
                this.sensorCollector = new SensorCollector({
                    throttle: 33, // 33ms Í∞ÑÍ≤© (30fps) - ÏÑ±Îä• ÏµúÏ†ÅÌôî
                    sensitivity: 1
                });
                
                // ÏÉÅÌÉú Í¥ÄÎ¶¨
                this.state = {
                    connected: false,
                    sessionConnected: false,
                    sensorActive: false,
                    currentSession: null
                };
                
                // DOM ÏöîÏÜå
                this.elements = {
                    statusIndicator: document.getElementById('statusIndicator'),
                    statusText: document.getElementById('statusText'),
                    message: document.getElementById('message'),
                    sessionInput: document.getElementById('sessionInput'),
                    connectButton: document.getElementById('connectButton'),
                    qrButton: document.getElementById('qrButton'),
                    gameInfo: document.getElementById('gameInfo'),
                    gameTypeBadge: document.getElementById('gameTypeBadge'),
                    connectedSensors: document.getElementById('connectedSensors'),
                    gameStatus: document.getElementById('gameStatus'),
                    sensorStatus: document.getElementById('sensorStatus'),
                    activityIndicator: document.getElementById('activityIndicator'),
                    sessionInputSection: document.getElementById('sessionInputSection'),
                    qrScannerSection: document.getElementById('qrScannerSection'),
                    startSensorBtn: document.getElementById('startSensorBtn'),
                    // ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥ ÏöîÏÜåÎì§
                    playerInfoCard: document.getElementById('playerInfoCard'),
                    playerAvatar: document.getElementById('playerAvatar'),
                    playerNumber: document.getElementById('playerNumber'),
                    playerName: document.getElementById('playerName'),
                    playerId: document.getElementById('playerId'),
                    // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú ÏöîÏÜåÎì§
                    tiltX: document.getElementById('tiltX'),
                    tiltY: document.getElementById('tiltY'),
                    rotationZ: document.getElementById('rotationZ'),
                    accelX: document.getElementById('accelX'),
                    accelY: document.getElementById('accelY'),
                    accelZ: document.getElementById('accelZ')
                };
                
                this.initializeApp();
            }
            
            async initializeApp() {
                console.log('üì± ÏÑºÏÑú Ïª®Ìä∏Î°§Îü¨ v6.0 Ï¥àÍ∏∞Ìôî');
                
                this.setupEventListeners();
                this.setupSDKEvents();
                
                // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú ÏÑ∏ÏÖò ÏΩîÎìú ÌôïÏù∏
                const urlParams = new URLSearchParams(window.location.search);
                const sessionCode = urlParams.get('session');
                
                if (sessionCode) {
                    this.elements.sessionInput.value = sessionCode;
                    this.showMessage('URLÏóêÏÑú ÏÑ∏ÏÖò ÏΩîÎìúÎ•º Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§.', 'success');
                }
                
                // ÏÑºÏÑú ÏßÄÏõê ÌôïÏù∏
                this.checkSensorSupport();
            }
            
            setupEventListeners() {
                // ÏÑ∏ÏÖò ÏûÖÎ†•
                this.elements.sessionInput.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
                    e.target.value = value;
                    
                    this.elements.connectButton.disabled = value.length !== 4 || !this.state.connected;
                });
                
                // Ïó∞Í≤∞ Î≤ÑÌäº
                this.elements.connectButton.addEventListener('click', () => {
                    this.connectToSession();
                });
                
                // QR Ïä§Ï∫î Î≤ÑÌäº
                this.elements.qrButton.addEventListener('click', () => {
                    this.scanQRCode();
                });
                
                // ÏÑºÏÑú ÏãúÏûë Î≤ÑÌäº
                this.elements.startSensorBtn.addEventListener('click', () => {
                    this.startSensorCollection();
                });
                
                // ÏóîÌÑ∞ÌÇ§ Ï≤òÎ¶¨
                this.elements.sessionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.elements.connectButton.disabled) {
                        this.connectToSession();
                    }
                });
            }
            
            setupSDKEvents() {
                // SDK Ïó∞Í≤∞ Ïù¥Î≤§Ìä∏
                this.sdk.on('connected', () => {
                    this.state.connected = true;
                    this.updateConnectionStatus('ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®', true);
                    this.elements.connectButton.disabled = this.elements.sessionInput.value.length !== 4;
                });
                
                this.sdk.on('disconnected', () => {
                    this.state.connected = false;
                    this.state.sessionConnected = false;
                    this.updateConnectionStatus('ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÎÅäÍπÄ', false);
                    this.elements.connectButton.disabled = true;
                    this.hideGameInfo();
                });
                
                this.sdk.on('connection-error', (data) => {
                    this.showMessage(`Ïó∞Í≤∞ Ïò§Î•ò: ${data.error}`, 'error');
                });
                
                // ÏÑºÏÑú Ïó∞Í≤∞ ÏÑ±Í≥µ
                this.sdk.on('sensor-connection-success', (event) => {
                    console.log('üîç ÏÑºÏÑú Ïó∞Í≤∞ ÏÑ±Í≥µ Ïù¥Î≤§Ìä∏:', event);
                    const data = event.detail || event;
                    console.log('üîç Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞:', data);
                    console.log('üîç Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞:', JSON.stringify(data, null, 2));
                    
                    this.state.sessionConnected = true;
                    this.state.currentSession = data;
                    
                    this.updateConnectionStatus(`Í≤åÏûÑÏóê Ïó∞Í≤∞Îê®`, true);
                    this.showGameInfo(data);
                    this.updatePlayerInfo(data);
                    
                    // ÏÑºÏÑú ÏãúÏûë Î≤ÑÌäº ÌôúÏÑ±Ìôî
                    this.elements.startSensorBtn.disabled = false;
                    
                    const sensorId = data.sensorId || data.id || 'Ïïå Ïàò ÏóÜÏùå';
                    this.showMessage(`${sensorId}Î°ú Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§!`, 'success');
                });
                
                // Í≤åÏûÑ ÏãúÏûë
                this.sdk.on('game-started', (data) => {
                    this.showMessage('Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§!', 'success');
                    this.elements.gameTypeBadge.textContent = `${data.gameType.toUpperCase()} - ÌîåÎ†àÏù¥ Ï§ë`;
                    this.elements.gameStatus.textContent = 'ÌîåÎ†àÏù¥ Ï§ë';
                });
                
                // Ìò∏Ïä§Ìä∏ Ïó∞Í≤∞ Ìï¥Ï†ú
                this.sdk.on('host-disconnected', () => {
                    this.showMessage('Í≤åÏûÑ Ìò∏Ïä§Ìä∏Í∞Ä Ïó∞Í≤∞ÏùÑ Ìï¥Ï†úÌñàÏäµÎãàÎã§.', 'warning');
                    this.resetConnection();
                });
                
                // ÏÑºÏÑú Ïò§Î•ò
                this.sdk.on('sensor-error', (data) => {
                    this.showMessage(`ÏÑºÏÑú Ïò§Î•ò: ${data.error}`, 'error');
                });
            }
            
            async connectToSession() {
                const sessionCode = this.elements.sessionInput.value.trim();
                
                if (!sessionCode || sessionCode.length !== 4) {
                    this.showMessage('Ïò¨Î∞îÎ•∏ 4ÏûêÎ¶¨ ÏÑ∏ÏÖò ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.', 'error');
                    return;
                }
                
                try {
                    this.elements.connectButton.disabled = true;
                    this.elements.connectButton.textContent = 'Ïó∞Í≤∞ Ï§ë...';
                    
                    await this.sdk.connectSensor(sessionCode, {
                        userAgent: navigator.userAgent,
                        screenSize: `${screen.width}x${screen.height}`,
                        timestamp: Date.now()
                    });
                    
                } catch (error) {
                    this.showMessage(`Ïó∞Í≤∞ Ïã§Ìå®: ${error.message}`, 'error');
                    this.elements.connectButton.disabled = false;
                    this.elements.connectButton.textContent = 'üîó Í≤åÏûÑÏóê Ïó∞Í≤∞';
                }
            }
            
            async scanQRCode() {
                try {
                    this.showMessage('QR ÏΩîÎìú Ïä§Ï∫êÎÑà Ï§ÄÎπÑ Ï§ë...', 'warning');
                    
                    // QR Ïä§Ï∫êÎÑà Ïª®ÌÖåÏù¥ÎÑà ÌëúÏãú
                    const qrReaderDiv = document.getElementById('qr-reader');
                    qrReaderDiv.style.display = 'block';
                    
                    // QR Ïä§Ï∫êÎÑà Ï¥àÍ∏∞Ìôî
                    const qrCodeScanner = new Html5QrcodeScanner("qr-reader", {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    });
                    
                    // ÏÑ±Í≥µ ÏΩúÎ∞±
                    const onScanSuccess = (decodedText) => {
                        try {
                            console.log('QR ÏΩîÎìú Ïä§Ï∫î ÏÑ±Í≥µ:', decodedText);
                            
                            // URLÏóêÏÑú ÏÑ∏ÏÖò ÏΩîÎìú Ï∂îÏ∂ú
                            const url = new URL(decodedText);
                            const sessionCode = url.searchParams.get('session');
                            
                            if (sessionCode && sessionCode.length === 4) {
                                this.elements.sessionInput.value = sessionCode;
                                this.showMessage('QR ÏΩîÎìúÏóêÏÑú ÏÑ∏ÏÖò ÏΩîÎìúÎ•º Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§.', 'success');
                                qrCodeScanner.clear();
                                qrReaderDiv.style.display = 'none';
                            } else {
                                this.showMessage('Ïò¨Î∞îÎ•∏ QR ÏΩîÎìúÍ∞Ä ÏïÑÎãôÎãàÎã§.', 'error');
                            }
                        } catch (err) {
                            console.error('QR ÏΩîÎìú ÌååÏã± Ïò§Î•ò:', err);
                            this.showMessage('QR ÏΩîÎìúÎ•º Ìï¥ÏÑùÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                        }
                    };
                    
                    // Ïò§Î•ò ÏΩúÎ∞±
                    const onScanError = (error) => {
                        // Ïä§Ï∫î Ïò§Î•òÎäî ÏùºÎ∞òÏ†ÅÏù¥ÎØÄÎ°ú Î°úÍ∑∏Îßå ÎÇ®Í∏∞Í≥† UIÏóêÎäî ÌëúÏãúÌïòÏßÄ ÏïäÏùå
                        console.log(`QR Ïä§Ï∫î ÏßÑÌñâ Ï§ë: ${error}`);
                    };
                    
                    // QR Ïä§Ï∫êÎÑà Î†åÎçîÎßÅ
                    qrCodeScanner.render(onScanSuccess, onScanError);
                    
                    this.showMessage('QR ÏΩîÎìúÎ•º Ïπ¥Î©îÎùºÏóê ÎπÑÏ∂∞Ï£ºÏÑ∏Ïöî.', 'success');
                    
                } catch (error) {
                    console.error('QR Ïä§Ï∫î Ïã§Ìå®:', error);
                    this.showMessage('Ïπ¥Î©îÎùºÏóê Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§. Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    
                    // QR Ïä§Ï∫êÎÑà Ïà®Í∏∞Í∏∞
                    const qrReaderDiv = document.getElementById('qr-reader');
                    if (qrReaderDiv) {
                        qrReaderDiv.style.display = 'none';
                    }
                }
            }
            
            async startSensorCollection() {
                try {
                    console.log('üîç ÏÑºÏÑú ÏàòÏßë ÏãúÏûë ÏãúÎèÑ...');
                    await this.sensorCollector.start();
                    this.state.sensorActive = true;
                    
                    // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ìï∏Îì§Îü¨
                    this.sensorCollector.onData((data) => {
                        console.log('üîç ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ ÏàòÏã†:', data);
                        this.updateSensorDisplay(data);
                        this.sendSensorData(data);
                        this.showActivity();
                    });
                    
                    this.elements.sensorStatus.classList.add('visible');
                    this.elements.startSensorBtn.textContent = '‚úÖ ÏÑºÏÑú ÌôúÏÑ±ÌôîÎê®';
                    this.elements.startSensorBtn.disabled = true;
                    this.showMessage('ÏÑºÏÑú ÏàòÏßëÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.', 'success');
                    console.log('‚úÖ ÏÑºÏÑú ÏàòÏßë ÏãúÏûë ÏôÑÎ£å');
                    
                } catch (error) {
                    console.error('‚ùå ÏÑºÏÑú ÏãúÏûë Ïã§Ìå®:', error);
                    this.showMessage(`ÏÑºÏÑú ÏãúÏûë Ïã§Ìå®: ${error.message}`, 'error');
                }
            }
            
            sendSensorData(data) {
                if (this.state.sessionConnected) {
                    console.log('üîç ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°:', data);
                    this.sdk.sendSensorData(data);
                } else {
                    console.log('‚ö†Ô∏è ÏÑ∏ÏÖò Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå - ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° Î∂àÍ∞Ä');
                }
            }
            
            updateSensorDisplay(data) {
                // Í∏∞Ïö∏Í∏∞ (orientation)
                this.elements.tiltX.textContent = (data.orientation.beta || 0).toFixed(1);
                this.elements.tiltY.textContent = (data.orientation.gamma || 0).toFixed(1);
                this.elements.rotationZ.textContent = (data.orientation.alpha || 0).toFixed(1);
                
                // Í∞ÄÏÜçÎèÑ (acceleration)
                this.elements.accelX.textContent = (data.acceleration.x || 0).toFixed(2);
                this.elements.accelY.textContent = (data.acceleration.y || 0).toFixed(2);
                this.elements.accelZ.textContent = (data.acceleration.z || 0).toFixed(2);
            }
            
            showActivity() {
                this.elements.activityIndicator.classList.add('active');
                
                clearTimeout(this.activityTimeout);
                this.activityTimeout = setTimeout(() => {
                    this.elements.activityIndicator.classList.remove('active');
                }, 200);
            }
            
            updateConnectionStatus(text, connected) {
                this.elements.statusText.textContent = text;
                this.elements.statusIndicator.classList.toggle('connected', connected);
            }
            
            showGameInfo(data) {
                this.elements.gameTypeBadge.textContent = data.gameType?.toUpperCase() || 'UNKNOWN';
                this.elements.connectedSensors.textContent = `${data.connectedSensors || 0}/${data.maxSensors || 1}`;
                this.elements.gameStatus.textContent = 'Ïó∞Í≤∞Îê®';
                
                this.elements.gameInfo.classList.add('visible');
                this.elements.sessionInputSection.style.display = 'none';
                this.elements.qrScannerSection.style.display = 'none';
            }
            
            updatePlayerInfo(data) {
                console.log('üîç updatePlayerInfo Ìò∏Ï∂úÎê®, data:', data);
                
                // Îã§ÏñëÌïú Í∞ÄÎä•Ìïú ÌïÑÎìúÎ™Ö ÌôïÏù∏
                const sensorId = data.sensorId || data.id || data.playerId || data.sensor || '';
                console.log('üîç Ï∂îÏ∂úÎêú sensorId:', sensorId);
                
                // ÌîåÎ†àÏù¥Ïñ¥ Î≤àÌò∏ Ï∂îÏ∂ú (Player1 -> 1, player2 -> 2, sensor1 -> 1 Îì±)
                const playerNumber = sensorId.match(/(\d+)/)?.[1] || '?';
                console.log('üîç Ï∂îÏ∂úÎêú playerNumber:', playerNumber);
                
                // ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                this.elements.playerNumber.textContent = playerNumber;
                this.elements.playerName.textContent = playerNumber !== '?' ? `ÌîåÎ†àÏù¥Ïñ¥ ${playerNumber}` : 'ÌîåÎ†àÏù¥Ïñ¥';
                this.elements.playerId.textContent = sensorId || 'Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...';
                
                // ÌîåÎ†àÏù¥Ïñ¥ ÏÉâÏÉÅ Ï†ÅÏö©
                this.elements.playerAvatar.className = 'player-avatar';
                if (playerNumber !== '?' && playerNumber >= 1 && playerNumber <= 8) {
                    this.elements.playerAvatar.classList.add(`player-color-${playerNumber}`);
                }
                
                console.log('üîç ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏Îêú Ï†ïÎ≥¥:', {
                    playerNumber: this.elements.playerNumber.textContent,
                    playerName: this.elements.playerName.textContent,
                    playerId: this.elements.playerId.textContent
                });
            }
            
            hideGameInfo() {
                this.elements.gameInfo.classList.remove('visible');
                this.elements.sensorStatus.classList.remove('visible');
                this.elements.sessionInputSection.style.display = 'block';
                this.elements.qrScannerSection.style.display = 'block';
            }
            
            resetConnection() {
                this.state.sessionConnected = false;
                this.state.sensorActive = false;
                this.state.currentSession = null;
                
                if (this.sensorCollector.isActive) {
                    this.sensorCollector.stop();
                }
                
                this.updateConnectionStatus('ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®', this.state.connected);
                this.hideGameInfo();
                
                this.elements.connectButton.disabled = this.elements.sessionInput.value.length !== 4 || !this.state.connected;
                this.elements.connectButton.textContent = 'üîó Í≤åÏûÑÏóê Ïó∞Í≤∞';
                this.elements.sessionInput.value = '';
            }
            
            checkSensorSupport() {
                if (!this.sensorCollector.checkSensorSupport()) {
                    this.showMessage('Ïù¥ Í∏∞Í∏∞Îäî ÏÑºÏÑúÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.', 'error');
                    this.elements.connectButton.disabled = true;
                    this.elements.qrButton.disabled = true;
                }
            }
            
            showMessage(text, type = 'success') {
                this.elements.message.textContent = text;
                this.elements.message.className = `message ${type} visible`;
                
                setTimeout(() => {
                    this.elements.message.classList.remove('visible');
                }, 5000);
            }
        }
        
        // Ïï± ÏãúÏûë
        document.addEventListener('DOMContentLoaded', () => {
            new SensorController();
        });
    </script>
</body>
</html>